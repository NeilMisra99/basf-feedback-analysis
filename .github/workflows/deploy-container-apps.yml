name: Deploy to Azure Container Apps

on:
  push:
    branches: [ main ]
    paths: 
      - 'backend/**'
      - '.github/workflows/deploy-container-apps.yml'
  workflow_dispatch:

env:
  REGISTRY_NAME: basffeedbackregistry
  IMAGE_NAME: basf-feedback-api
  CONTAINER_APP_NAME: basf-feedback-api

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Build and push Docker image
      run: |
        # Build Docker image from backend directory
        docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} backend/
        docker build -t ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest backend/
        
        # Push Docker image
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy to Container Apps
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group feedback-analysis-rg \
          --container-name ${{ env.CONTAINER_APP_NAME }} \
          --image ${{ secrets.REGISTRY_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          --min-replicas 1 \
          --max-replicas 10 \
          --set-env-vars \
            FLASK_ENV=production \
            PORT=8080 \
            AZURE_TEXT_ANALYTICS_KEY="${{ secrets.AZURE_TEXT_ANALYTICS_KEY }}" \
            AZURE_TEXT_ANALYTICS_ENDPOINT="${{ secrets.AZURE_TEXT_ANALYTICS_ENDPOINT }}" \
            AZURE_SPEECH_KEY="${{ secrets.AZURE_SPEECH_KEY }}" \
            AZURE_SPEECH_REGION="${{ secrets.AZURE_SPEECH_REGION }}" \
            AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            OPENAI_MODEL="${{ secrets.OPENAI_MODEL }}" \
            SECRET_KEY="${{ secrets.SECRET_KEY }}" \
            CORS_ORIGINS="${{ secrets.CORS_ORIGINS }}"